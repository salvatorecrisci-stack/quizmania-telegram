<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMania Daily</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container { max-width: 500px; margin: 0 auto; }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logo { text-align: center; margin-bottom: 30px; }
        .logo-icon { font-size: 100px; margin-bottom: 10px; }
        h1 { font-size: 48px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { font-size: 18px; opacity: 0.9; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .premium-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: gold;
            color: #333;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .stat-value { font-size: 42px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        button:active { transform: scale(0.98); }

        .btn-primary {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-premium {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .quiz-header { margin-bottom: 20px; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s;
            width: 0%;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .timer {
            display: inline-block;
            min-width: 60px;
            text-align: center;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        .timer.warning {
            background: #e74c3c;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .power-ups {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .power-up-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .power-up-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .power-up-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .power-up-icon { font-size: 24px; }
        .power-up-cost {
            font-size: 12px;
            opacity: 0.9;
        }

        .question-card {
            background: white;
            color: #2c3e50;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .question-card h2 {
            font-size: 24px;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .option {
            background: #f8f9fa;
            padding: 18px;
            margin: 12px 0;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: #667eea;
            background: #e8ecff;
        }

        .option.correct {
            background: #2ecc71;
            color: white;
            border-color: #27ae60;
        }

        .option.wrong {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .option.hint {
            background: #f39c12;
            color: white;
            border-color: #e67e22;
            animation: hintPulse 1s;
        }

        @keyframes hintPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .results-icon { font-size: 120px; text-align: center; margin: 20px 0; }
        .score-big { font-size: 72px; font-weight: bold; text-align: center; margin: 20px 0; }
        .score-message { text-align: center; font-size: 28px; margin-bottom: 30px; }

        .leaderboard {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .rank { font-size: 24px; font-weight: bold; min-width: 50px; }
        .player-name { flex: 1; font-size: 16px; }
        .player-score { font-size: 20px; font-weight: bold; }

        .empty-state { text-align: center; padding: 40px; opacity: 0.7; }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HOME -->
        <div class="screen active" id="home">
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <h1>QuizMania</h1>
                <p class="subtitle">Daily Brain Challenge</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalScore">0</div>
                    <div class="stat-label">Punteggio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Streak üî•</div>
                </div>
            </div>

            <button class="btn-primary" onclick="startQuiz()">üéØ Inizia Quiz</button>
            <button class="btn-secondary" onclick="showLeaderboard()">üèÜ Classifica</button>
            <button class="btn-premium" onclick="showPremium()">‚≠ê Ottieni Power-Ups</button>
        </div>

        <!-- QUIZ -->
        <div class="screen" id="quiz">
            <div class="quiz-header">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div class="quiz-info">
                    <span>Domanda <span id="qNum">1</span>/10</span>
                    <span class="timer" id="timer">‚è±Ô∏è 20s</span>
                </div>
                
                <div class="power-ups">
                    <button class="power-up-btn" id="hintBtn" onclick="buyHint()">
                        <span class="power-up-icon">üí°</span>
                        <span>Hint</span>
                        <span class="power-up-cost">10 ‚≠ê</span>
                    </button>
                    <button class="power-up-btn" id="timeBtn" onclick="buyTime()">
                        <span class="power-up-icon">‚è∞</span>
                        <span>+10s</span>
                        <span class="power-up-cost">5 ‚≠ê</span>
                    </button>
                    <button class="power-up-btn" id="skipBtn" onclick="buySkip()">
                        <span class="power-up-icon">‚è≠Ô∏è</span>
                        <span>Skip</span>
                        <span class="power-up-cost">15 ‚≠ê</span>
                    </button>
                </div>
            </div>

            <div class="question-card">
                <h2 id="qText"></h2>
                <div id="options"></div>
            </div>
        </div>

        <!-- RISULTATO -->
        <div class="screen" id="result">
            <div class="results-icon" id="resultIcon">üéâ</div>
            <h1>Quiz Completato!</h1>
            
            <div class="score-big" id="finalScore">0/10</div>
            <p class="score-message" id="scoreMsg"></p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">Corrette</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pointsEarned">0</div>
                    <div class="stat-label">Punti</div>
                </div>
            </div>

            <button class="btn-primary" onclick="shareResult()">üì§ Condividi</button>
            <button class="btn-secondary" onclick="showLeaderboard()">üèÜ Classifica</button>
            <button class="btn-secondary" onclick="goHome()">üè† Home</button>
        </div>

        <!-- CLASSIFICA -->
        <div class="screen" id="leaderboard">
            <h1 style="text-align: center; margin-bottom: 20px;">üèÜ Classifica</h1>
            <div class="leaderboard" id="leaderboardList"></div>
            <button class="btn-secondary" onclick="goHome()">üè† Home</button>
        </div>

        <!-- PREMIUM/POWER-UPS -->
        <div class="screen" id="premium">
            <h1 style="text-align: center; margin-bottom: 20px;">‚≠ê Power-Ups</h1>
            
            <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin: 20px 0;">
                <h2 style="font-size: 24px; margin-bottom: 15px;">üí° Hint</h2>
                <p style="opacity: 0.9; margin-bottom: 15px;">Mostra la risposta corretta durante il quiz</p>
                <p style="font-size: 32px; font-weight: bold; margin-bottom: 15px;">10 ‚≠ê Stars</p>
                <button class="btn-primary" onclick="purchasePowerUp('hint', 10)">Acquista Hint</button>
            </div>

            <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin: 20px 0;">
                <h2 style="font-size: 24px; margin-bottom: 15px;">‚è∞ Tempo Bonus</h2>
                <p style="opacity: 0.9; margin-bottom: 15px;">Aggiungi 10 secondi extra al timer</p>
                <p style="font-size: 32px; font-weight: bold; margin-bottom: 15px;">5 ‚≠ê Stars</p>
                <button class="btn-primary" onclick="purchasePowerUp('time', 5)">Acquista Tempo</button>
            </div>

            <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin: 20px 0;">
                <h2 style="font-size: 24px; margin-bottom: 15px;">‚è≠Ô∏è Skip Domanda</h2>
                <p style="opacity: 0.9; margin-bottom: 15px;">Salta una domanda difficile</p>
                <p style="font-size: 32px; font-weight: bold; margin-bottom: 15px;">15 ‚≠ê Stars</p>
                <button class="btn-primary" onclick="purchasePowerUp('skip', 15)">Acquista Skip</button>
            </div>

            <button class="btn-secondary" onclick="goHome()">üè† Home</button>
        </div>
    </div>

    <script>
        // Telegram
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        function getUser() {
            if (tg?.initDataUnsafe?.user) {
                return {
                    id: tg.initDataUnsafe.user.id,
                    name: tg.initDataUnsafe.user.first_name || 'Giocatore'
                };
            }
            return { id: 'test_' + Date.now(), name: 'Giocatore' };
        }

        const user = getUser();

        // Domande
        const questions = [
            { q: "Capitale d'Italia?", opts: ["Milano", "Roma", "Napoli", "Firenze"], correct: 1 },
            { q: "Chi ha dipinto la Gioconda?", opts: ["Michelangelo", "Raffaello", "Leonardo da Vinci", "Caravaggio"], correct: 2 },
            { q: "Quanti continenti?", opts: ["5", "6", "7", "8"], correct: 2 },
            { q: "Pianeta pi√π grande?", opts: ["Saturno", "Giove", "Nettuno", "Urano"], correct: 1 },
            { q: "Anno caduta Muro di Berlino?", opts: ["1987", "1989", "1991", "1993"], correct: 1 },
            { q: "Chi ha scritto La Divina Commedia?", opts: ["Petrarca", "Boccaccio", "Dante", "Ariosto"], correct: 2 },
            { q: "Oceano pi√π grande?", opts: ["Atlantico", "Indiano", "Artico", "Pacifico"], correct: 3 },
            { q: "Quante regioni in Italia?", opts: ["18", "19", "20", "21"], correct: 2 },
            { q: "Chi ha inventato la lampadina?", opts: ["Tesla", "Edison", "Franklin", "Bell"], correct: 1 },
            { q: "Fiume pi√π lungo d'Italia?", opts: ["Tevere", "Arno", "Po", "Adige"], correct: 2 }
        ];

        let currentQ = 0;
        let score = 0;
        let timeLeft = 20;
        let timerInterval = null;
        let hintUsed = false;

        // Init
        loadUserData();

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showNotification(msg) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function loadUserData() {
            try {
                const data = JSON.parse(localStorage.getItem('qm_' + user.id) || '{}');
                document.getElementById('totalScore').textContent = data.total || 0;
                document.getElementById('streak').textContent = data.streak || 0;
            } catch(e) {}
        }

        function saveUserData(pts) {
            try {
                let data = JSON.parse(localStorage.getItem('qm_' + user.id) || '{}');
                data.total = (data.total || 0) + pts;
                
                const today = new Date().toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (data.lastPlay === yesterday.toDateString()) {
                    data.streak = (data.streak || 0) + 1;
                } else if (data.lastPlay !== today) {
                    data.streak = 1;
                }
                
                data.lastPlay = today;
                localStorage.setItem('qm_' + user.id, JSON.stringify(data));
                loadUserData();
            } catch(e) {}
        }

        function startQuiz() {
            currentQ = 0;
            score = 0;
            hintUsed = false;
            showScreen('quiz');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQ >= questions.length) {
                showResults();
                return;
            }

            const q = questions[currentQ];
            
            document.getElementById('qNum').textContent = currentQ + 1;
            document.getElementById('qText').textContent = q.q;
            document.getElementById('progressBar').style.width = ((currentQ + 1) / questions.length * 100) + '%';

            const container = document.getElementById('options');
            container.innerHTML = '';

            q.opts.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = opt;
                div.onclick = () => checkAnswer(i);
                container.appendChild(div);
            });

            // Reset power-ups buttons
            document.getElementById('hintBtn').disabled = false;
            document.getElementById('timeBtn').disabled = false;
            document.getElementById('skipBtn').disabled = false;
            hintUsed = false;

            timeLeft = 20;
            updateTimer();
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(-1);
                }
            }, 1000);
        }

        function updateTimer() {
            const t = document.getElementById('timer');
            t.textContent = `‚è±Ô∏è ${timeLeft}s`;
            if (timeLeft <= 5) t.classList.add('warning');
            else t.classList.remove('warning');
        }

        function checkAnswer(idx) {
            clearInterval(timerInterval);
            
            const q = questions[currentQ];
            const opts = document.querySelectorAll('.option');
            
            opts.forEach(o => {
                o.classList.add('disabled');
                o.onclick = null;
            });

            opts[q.correct].classList.add('correct');

            if (idx === q.correct) {
                score++;
                if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            } else if (idx !== -1) {
                opts[idx].classList.add('wrong');
                if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
            }

            setTimeout(() => {
                currentQ++;
                loadQuestion();
            }, 1500);
        }

        // Power-ups durante il quiz
        function buyHint() {
            if (hintUsed) {
                showNotification('Hint gi√† usato!');
                return;
            }
            
            invokeStarPayment(10, 'hint');
        }

        function buyTime() {
            invokeStarPayment(5, 'time');
        }

        function buySkip() {
            invokeStarPayment(15, 'skip');
        }

        function applyHint() {
            const q = questions[currentQ];
            const opts = document.querySelectorAll('.option');
            opts[q.correct].classList.add('hint');
            hintUsed = true;
            document.getElementById('hintBtn').disabled = true;
            showNotification('üí° Risposta evidenziata!');
        }

        function applyTime() {
            timeLeft += 10;
            updateTimer();
            document.getElementById('timeBtn').disabled = true;
            showNotification('‚è∞ +10 secondi!');
        }

        function applySkip() {
            clearInterval(timerInterval);
            currentQ++;
            document.getElementById('skipBtn').disabled = true;
            showNotification('‚è≠Ô∏è Domanda saltata!');
            loadQuestion();
        }

        // Pagamenti Telegram Stars
        function invokeStarPayment(amount, type) {
            if (!tg?.openInvoice) {
                // Modalit√† test - simula pagamento
                showNotification(`Pagamento ${amount} ‚≠ê simulato (solo test)`);
                applyPowerUp(type);
                return;
            }

            // Crea invoice per Telegram Stars
            const invoice = {
                title: getPowerUpTitle(type),
                description: getPowerUpDescription(type),
                payload: JSON.stringify({ type: type, userId: user.id }),
                provider_token: '', // Empty for Stars
                currency: 'XTR', // Telegram Stars
                prices: [{ label: 'Power-Up', amount: amount }]
            };

            tg.openInvoice(invoice, (status) => {
                if (status === 'paid') {
                    applyPowerUp(type);
                    showNotification('‚úÖ Acquisto completato!');
                } else {
                    showNotification('‚ùå Pagamento annullato');
                }
            });
        }

        function getPowerUpTitle(type) {
            const titles = {
                'hint': 'üí° Hint',
                'time': '‚è∞ Tempo Bonus',
                'skip': '‚è≠Ô∏è Skip Domanda'
            };
            return titles[type] || 'Power-Up';
        }

        function getPowerUpDescription(type) {
            const descs = {
                'hint': 'Mostra la risposta corretta',
                'time': 'Aggiungi 10 secondi',
                'skip': 'Salta domanda difficile'
            };
            return descs[type] || '';
        }

        function applyPowerUp(type) {
            switch(type) {
                case 'hint': applyHint(); break;
                case 'time': applyTime(); break;
                case 'skip': applySkip(); break;
            }
        }

        // Acquisti dalla pagina Premium
        function purchasePowerUp(type, amount) {
            invokeStarPayment(amount, type);
        }

        function showResults() {
            const pct = (score / questions.length) * 100;
            const pts = score * 10;
            
            document.getElementById('finalScore').textContent = `${score}/${questions.length}`;
            document.getElementById('correctCount').textContent = score;
            document.getElementById('pointsEarned').textContent = pts;
            
            let icon = 'üéâ', msg = '';
            
            if (pct === 100) {
                icon = 'üåü';
                msg = 'PERFETTO! Sei un genio!';
            } else if (pct >= 80) {
                icon = 'üéâ';
                msg = 'ECCELLENTE!';
            } else if (pct >= 60) {
                icon = 'üëç';
                msg = 'BENE!';
            } else if (pct >= 40) {
                icon = 'üí™';
                msg = 'Puoi migliorare!';
            } else {
                icon = 'üìö';
                msg = 'Continua ad allenarti!';
            }
            
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('scoreMsg').textContent = msg;
            
            saveUserData(pts);
            saveToLeaderboard(score);
            showScreen('result');
        }

        function saveToLeaderboard(s) {
            try {
                let lb = JSON.parse(localStorage.getItem('qm_lb') || '[]');
                lb.push({ name: user.name, id: user.id, score: s, date: new Date().toISOString() });
                lb.sort((a, b) => b.score - a.score);
                lb = lb.slice(0, 100);
                localStorage.setItem('qm_lb', JSON.stringify(lb));
            } catch(e) {}
        }

        function showLeaderboard() {
            const lb = JSON.parse(localStorage.getItem('qm_lb') || '[]');
            const container = document.getElementById('leaderboardList');
            container.innerHTML = '';
            
            if (lb.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="font-size:48px">üèÜ</p><p>Nessun punteggio!</p></div>';
            } else {
                lb.slice(0, 50).forEach((e, i) => {
                    let medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span class="rank">${medal}</span>
                        <span class="player-name">${e.name}</span>
                        <span class="player-score">${e.score}/10</span>
                    `;
                    container.appendChild(item);
                });
            }
            
            showScreen('leaderboard');
        }

        function shareResult() {
            const msg = `üß† Ho fatto ${score}/${questions.length} nel QuizMania Daily!\n\nRiesci a battermi? üéØ`;
            if (tg) {
                try {
                    tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/quiz_daily_italia_bot&text=${encodeURIComponent(msg)}`);
                } catch(e) {
                    alert(msg);
                }
            } else {
                alert(msg);
            }
        }

        function showPremium() {
            showScreen('premium');
        }

        function goHome() {
            showScreen('home');
            loadUserData();
        }

        console.log('‚úÖ QuizMania con Stars OK!');
    </script>
</body>
</html>
